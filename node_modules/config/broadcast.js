var gcm = require('node-gcm');
var fs = require('fs');
//var mongoose = require('mongoose'); 
var event = require('config/modelEvent');   
var user = require('config/models'); 

var formidable = require("formidable");

// create a message with default values
var googleApiKey = 'AIzaSyAlOAwGDGVgt1IOEALhg7AMb7SzTiMMKqI';

exports.broadcast = function(req,res, callback) {  
	var sender = new gcm.Sender(googleApiKey);
	var message = new gcm.Message();
	var form = new formidable.IncomingForm();

	//Parsing the HTML form
	form.parse(req, function (err, fields, files) {
		//Getting both variables from form
		var lengthTime = fields.length;
		var amountEnergy = fields.amountEnergy

		//Checking if values is correct
		console.log(lengthTime);
		console.log(amountEnergy);
	});
	
	//Creating a new document for an new event
	new event().save();
	

        message.addData('title','Hurry Up!');
	message.addData('message', 'Save penguins! Turn off some appliances for 10 mins');
	//TODO:LAUR Same problem here. amountEnergy remains undefined. Have to ficure out how all that stuff work
        //message.addData('requiredAmount', amountEnergy);
	

	console.log(message);
	message.delay_while_idle = 1;
	var registrationIds = [];

	user.find(function(err, users) {  
		users.forEach(function(user) {
			registrationIds.push(user.gcmregid);
			console.log("GCM Key " + user.gcmregid);  
	        });

		sender.send(message, registrationIds, 4, function (err, result) {
			console.log(result);
		});
	});	
}

exports.displayForm = function (res) {
    fs.readFile('broadcast.html', function (err, data) {
        res.writeHead(200, {
            'Content-Type': 'text/html',
                'Content-Length': data.length
        });
        res.write(data);
        res.end();
    });
}
