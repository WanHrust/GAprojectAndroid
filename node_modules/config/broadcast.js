var gcm = require('node-gcm');
var fs = require('fs');
var event = require('config/modelEvent');   
var user = require('config/models'); 
var progress = require ('config/sendProgress');

var formidable = require("formidable");

// create a message with default values
var googleApiKey = 'AIzaSyBltm3ZxV7V6nfxqGdVlML9LMqPzc_jTn0';

exports.broadcast = function(req,res, callback) {  
	var sender = new gcm.Sender(googleApiKey);
	var message = new gcm.Message();
	var form = new formidable.IncomingForm();

	//Creating a new document for an new event
	new event().save();
	
	//Parsing the HTML form and sending notifications
	form.parse(req, function (err, fields, files) {
		//Adding data from the form to the message
		message.addData('title',fields.title);
		message.addData('message', fields.message);
		message.addData('requiredAmount', fields.amountEnergy);
		message.addData('time',fields.time_action);
		message.addData('messageType', 'actionstarted'); //Now we need to distinguish between message types. Using them we can create a "state machine" in the app

		message.delay_while_idle = 1;
		var registrationIds = [];
		
		var frequency = 5; //number of seconds before sending the progress again
		
		//Finding users who should be receiving the notifications
		user.find(function(err, users) {  
			users.forEach(function(user) {
				registrationIds.push(user.gcmregid);
		        });
	
			//Sending progress (time_action is in minutes and frequency in seconds)
			progress.sendProgress(fields.time_action, frequency, registrationIds);
			
			//Sending message
			sender.send(message, registrationIds, 4, function (err, result) {
				console.log(result);
				callback(result);
			});
          
		});
	});
}

exports.displayForm = function (res) {
    fs.readFile('broadcast.html', function (err, data) {
        res.writeHead(200, {
            'Content-Type': 'text/html',
                'Content-Length': data.length
        });
        res.write(data);
        res.end();
    });
}
