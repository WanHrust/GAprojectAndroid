var crypto = require('crypto'); 
var rand = require('csprng'); 
var mongoose = require('mongoose'); 
var gravatar = require('gravatar'); 
var Event = require('config/modelEvent');  
var ActionModel = require('config/modelAction');

exports.action = function(act,userEmail, callback) {  

    //Finding the last Event
    Event.findOne({}, {}, { sort: { 'date_action' : -1 } }, function(err, event) {
        //Add the action of the user to the ones of the actions
        var newAction = new ActionModel({ email : userEmail, amountEnergy : act });
        
        newAction.save(function(err) {
            if (err)
                throw err;
        });
        
        if(event.usersActing == undefined){
            event.usersActing = [newAction];
        }
        else{
            event.usersActing.push(newAction); 
        }

        event.save(function(err) {
            if (err) 
                throw err;
            console.log('Unexpected success!');    
        });
        
    });
    
    console.log(act);
    callback({'response':act, 'res':"true"});   
}  

Event.aggregate([
    // Unwind to "de-normalize"
    { "$unwind": "$usersActing" },
    
    { "$group": {
        "_id": null,
        "total": { "$sum" : "$usersActing.amountEnergy" }
        }}
    ],function(err,result) {
        //Should print the total
        console.log(result.total)
})
