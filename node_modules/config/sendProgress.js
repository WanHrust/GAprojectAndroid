var gcm = require('node-gcm');
var event = require('config/modelEvent');   
var googleApiKey = 'AIzaSyAlOAwGDGVgt1IOEALhg7AMb7SzTiMMKqI';
var timeout = 60; //number of minutes during which this is done

//Aggregation function
var getProgess = function() {
    Event.aggregate([
        { $unwind: "$usersActing" },
        { $group: {
            _id: null,
            balance: { $sum: "$usersActing.amountEnergy"  }
        }}
    ], function (err, balance) {
        if (err) {
            console.log(err);
            return;
        }
        console.log(balance);
    });
}

function timer() {
    var sender = new gcm.Sender(googleApiKey);
    var message = new gcm.Message();
    
    message.addData('message', getProgress());

  	console.log(message);
  	message.delay_while_idle = 1;
  	var registrationIds = [];
  
    event.findOne({}, {}, { sort: { 'date_action' : -1 } }, function(err, lastEvent) {
      lastEvent.find(function(err, users) {  
  		  users.forEach(function(user) {
    			registrationIds.push(user.gcmregid);
    			console.log("GCM Key " + user.gcmregid);  
    	  });
  
  	    sender.send(message, registrationIds, 4, function (err, result) {
  			  console.log(result);
  		  });
  	  });   
    });
}

function stopFunction(timerFunction) {
    clearInterval(timerFunction);
} 

exports.sendProgress = function(req,res, callback) {  
	//Calling function every minute
  var sendingPieces = window.setInterval(function(){ timer() }, 1000*60);
  
  //Stoping function after a certain amount of time
  window.setTimeout(function(){ stopFunction(sendingPieces); }, 1000*60*60);
}
